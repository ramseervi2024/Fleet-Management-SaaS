<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard â€” Fleet Management</title>
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>
    <div class="app-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-logo">
                <div class="logo-icon">ğŸš›</div>
                <div>
                    <span id="sidebar-tenant-name">Fleet Co.</span>
                    <small>Fleet Management</small>
                </div>
            </div>
            <nav class="sidebar-nav">
                <p class="nav-section-label">Overview</p>
                <a href="/dashboard.html" class="nav-item active"><span class="nav-icon">ğŸ“Š</span> Dashboard</a>
                <p class="nav-section-label">Fleet</p>
                <a href="/vehicles.html" class="nav-item"><span class="nav-icon">ğŸš—</span> Vehicles</a>
                <a href="/drivers.html" class="nav-item"><span class="nav-icon">ğŸ‘¤</span> Drivers</a>
                <a href="/trips.html" class="nav-item"><span class="nav-icon">ğŸ—ºï¸</span> Trips</a>
                <p class="nav-section-label">Logs</p>
                <a href="/maintenance.html" class="nav-item"><span class="nav-icon">ğŸ”§</span> Maintenance</a>
                <a href="/fuel-logs.html" class="nav-item"><span class="nav-icon">â›½</span> Fuel Logs</a>
                <p class="nav-section-label">System</p>
                <a href="/api-docs" target="_blank" class="nav-item"><span class="nav-icon">ğŸ“‹</span> API Docs</a>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar" id="sidebar-user-avatar">U</div>
                    <div style="flex: 1; min-width: 0;">
                        <div class="user-name" id="sidebar-user-name">Loading...</div>
                        <div class="user-role" id="sidebar-user-role">role</div>
                    </div>
                    <button onclick="auth.logout()" title="Logout"
                        style="background:none;border:none;cursor:pointer;color:var(--text-muted);font-size:16px;">â»</button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="main-content">
            <header class="top-header">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <button class="hamburger" id="hamburger-btn">â˜°</button>
                    <h1 class="page-title">Dashboard</h1>
                </div>
                <div class="header-actions">
                    <div class="header-badge" id="connection-badge">Live</div>
                    <button class="btn btn-secondary btn-sm" onclick="loadDashboard()">â†» Refresh</button>
                </div>
            </header>

            <main class="page-content">
                <!-- KPI Cards -->
                <div class="kpi-grid" id="kpi-grid">
                    <div class="kpi-card blue">
                        <div class="kpi-info">
                            <h3>Total Vehicles</h3>
                            <div class="kpi-value" id="kpi-vehicles">â€”</div>
                            <div class="kpi-sub" id="kpi-vehicles-sub">Loading...</div>
                        </div>
                        <div class="kpi-icon blue">ğŸš—</div>
                    </div>
                    <div class="kpi-card green">
                        <div class="kpi-info">
                            <h3>Total Drivers</h3>
                            <div class="kpi-value" id="kpi-drivers">â€”</div>
                            <div class="kpi-sub" id="kpi-drivers-sub">Loading...</div>
                        </div>
                        <div class="kpi-icon green">ğŸ‘¤</div>
                    </div>
                    <div class="kpi-card amber">
                        <div class="kpi-info">
                            <h3>Total Trips</h3>
                            <div class="kpi-value" id="kpi-trips">â€”</div>
                            <div class="kpi-sub" id="kpi-trips-sub">Loading...</div>
                        </div>
                        <div class="kpi-icon amber">ğŸ—ºï¸</div>
                    </div>
                    <div class="kpi-card red">
                        <div class="kpi-info">
                            <h3>Maintenance</h3>
                            <div class="kpi-value" id="kpi-maintenance">â€”</div>
                            <div class="kpi-sub">Pending / Scheduled</div>
                        </div>
                        <div class="kpi-icon red">ğŸ”§</div>
                    </div>
                    <div class="kpi-card purple">
                        <div class="kpi-info">
                            <h3>Active Trips</h3>
                            <div class="kpi-value" id="kpi-active-trips">â€”</div>
                            <div class="kpi-sub">In-Progress Now</div>
                        </div>
                        <div class="kpi-icon purple">ğŸ“</div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="charts-grid">
                    <div class="chart-card">
                        <h3>ğŸ“ˆ Monthly Trips (6 months)</h3>
                        <div class="chart-bars" id="trips-chart"></div>
                    </div>
                    <div class="chart-card">
                        <h3>â›½ Monthly Fuel Cost (6 months)</h3>
                        <div class="chart-bars" id="fuel-chart"></div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="section-header">
                    <div>
                        <div class="section-title">Recent Trips</div>
                        <div class="section-subtitle">Latest trip activity in your fleet</div>
                    </div>
                    <a href="/trips.html" class="btn btn-secondary btn-sm">View All â†’</a>
                </div>
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Trip #</th>
                                <th>Vehicle</th>
                                <th>Driver</th>
                                <th>Origin â†’ Destination</th>
                                <th>Status</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody id="recent-trips-body">
                            <tr>
                                <td colspan="6" class="page-loader">
                                    <div class="spinner"></div> Loading trips...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </main>
        </div>
    </div>

    <script src="/js/api.js"></script>
    <script>
        requireAuth();

        const statusBadge = {
            active: 'badge-green', idle: 'badge-amber', maintenance: 'badge-red', retired: 'badge-gray',
            available: 'badge-green', 'on-trip': 'badge-blue', 'off-duty': 'badge-amber', suspended: 'badge-red',
            scheduled: 'badge-amber', 'in-progress': 'badge-blue', completed: 'badge-green', cancelled: 'badge-red', delayed: 'badge-red',
        };

        async function loadDashboard() {
            const res = await api.get('/dashboard/stats');
            if (!res?.ok) { toast.error('Failed to load dashboard stats.'); return; }
            const { stats, charts, recent } = res.data;

            // KPIs
            document.getElementById('kpi-vehicles').textContent = stats.vehicles.total;
            document.getElementById('kpi-vehicles-sub').textContent = `${stats.vehicles.active} active Â· ${stats.vehicles.idle} idle Â· ${stats.vehicles.maintenance} maintenance`;
            document.getElementById('kpi-drivers').textContent = stats.drivers.total;
            document.getElementById('kpi-drivers-sub').textContent = `${stats.drivers.available} available Â· ${stats.drivers.onTrip} on trip`;
            document.getElementById('kpi-trips').textContent = stats.trips.total;
            document.getElementById('kpi-trips-sub').textContent = `${stats.trips.completed} completed`;
            document.getElementById('kpi-maintenance').textContent = stats.maintenance.pending;
            document.getElementById('kpi-active-trips').textContent = stats.trips.active;

            // Charts
            renderBarChart('trips-chart', charts.monthlyTrips.map(d => ({ label: `${d._id.month}/${d._id.year}`, value: d.count })), 'blue');
            renderBarChart('fuel-chart', charts.monthlyFuel.map(d => ({ label: `${d._id.month}/${d._id.year}`, value: d.totalCost })), 'green');

            // Recent Trips
            const tbody = document.getElementById('recent-trips-body');
            if (!recent.trips.length) {
                tbody.innerHTML = `<tr><td colspan="6"><div class="empty-state"><div class="empty-icon">ğŸ—ºï¸</div><h3>No trips yet</h3><p>Create your first trip to get started.</p></div></td></tr>`;
                return;
            }
            tbody.innerHTML = recent.trips.map(t => `
    <tr>
      <td><span class="fw-600">${t.tripNumber}</span></td>
      <td>${t.vehicle?.registrationNumber || 'â€”'} <span class="text-muted" style="font-size:.75rem;">${t.vehicle?.make || ''}</span></td>
      <td>${t.driver?.name || 'â€”'}</td>
      <td>${t.origin?.address || 'â€”'} â†’ ${t.destination?.address || 'â€”'}</td>
      <td><span class="badge ${statusBadge[t.status] || 'badge-gray'}">${t.status}</span></td>
      <td>${formatDate(t.createdAt)}</td>
    </tr>
  `).join('');
        }

        function renderBarChart(containerId, data, color) {
            const container = document.getElementById(containerId);
            if (!data.length) { container.innerHTML = `<p class="text-muted" style="font-size:.8rem;">No data yet</p>`; return; }
            const max = Math.max(...data.map(d => d.value), 1);
            container.innerHTML = data.map(d => `
    <div class="chart-bar-wrap">
      <div class="chart-bar ${color}" style="height: ${Math.max(8, (d.value / max) * 90)}px;" title="${d.value}"></div>
      <span class="chart-label">${d.label}</span>
    </div>
  `).join('');
        }

        loadDashboard();
    </script>
</body>

</html>