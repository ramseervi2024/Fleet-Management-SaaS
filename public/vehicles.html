<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicles ‚Äî Fleet Management</title>
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>
    <div class="app-layout">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-logo">
                <div class="logo-icon">üöõ</div>
                <div><span id="sidebar-tenant-name">Fleet Co.</span><small>Fleet Management</small></div>
            </div>
            <nav class="sidebar-nav">
                <p class="nav-section-label">Overview</p>
                <a href="/dashboard.html" class="nav-item"><span class="nav-icon">üìä</span> Dashboard</a>
                <p class="nav-section-label">Fleet</p>
                <a href="/vehicles.html" class="nav-item active"><span class="nav-icon">üöó</span> Vehicles</a>
                <a href="/drivers.html" class="nav-item"><span class="nav-icon">üë§</span> Drivers</a>
                <a href="/trips.html" class="nav-item"><span class="nav-icon">üó∫Ô∏è</span> Trips</a>
                <p class="nav-section-label">Logs</p>
                <a href="/maintenance.html" class="nav-item"><span class="nav-icon">üîß</span> Maintenance</a>
                <a href="/fuel-logs.html" class="nav-item"><span class="nav-icon">‚õΩ</span> Fuel Logs</a>
                <p class="nav-section-label">System</p>
                <a href="/api-docs" target="_blank" class="nav-item"><span class="nav-icon">üìã</span> API Docs</a>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar" id="sidebar-user-avatar">U</div>
                    <div style="flex:1;min-width:0;">
                        <div class="user-name" id="sidebar-user-name">...</div>
                        <div class="user-role" id="sidebar-user-role">role</div>
                    </div>
                    <button onclick="auth.logout()"
                        style="background:none;border:none;cursor:pointer;color:var(--text-muted);font-size:16px;">‚èª</button>
                </div>
            </div>
        </aside>

        <div class="main-content">
            <header class="top-header">
                <div style="display:flex;align-items:center;gap:12px;">
                    <button class="hamburger" id="hamburger-btn">‚ò∞</button>
                    <h1 class="page-title">Vehicles</h1>
                </div>
                <div class="header-actions">
                    <button class="btn btn-primary btn-sm" onclick="openModal()">+ Add Vehicle</button>
                </div>
            </header>

            <main class="page-content">
                <div class="filter-bar">
                    <div class="search-input-wrapper">
                        <span class="search-icon">üîç</span>
                        <input type="text" class="form-input" id="search-input"
                            placeholder="Search by registration, make, model..." oninput="debounceSearch()">
                    </div>
                    <select class="form-select" style="width:160px;" id="status-filter" onchange="loadVehicles()">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="idle">Idle</option>
                        <option value="maintenance">Maintenance</option>
                        <option value="retired">Retired</option>
                    </select>
                    <select class="form-select" style="width:140px;" id="type-filter" onchange="loadVehicles()">
                        <option value="">All Types</option>
                        <option value="truck">Truck</option>
                        <option value="van">Van</option>
                        <option value="car">Car</option>
                        <option value="bus">Bus</option>
                        <option value="suv">SUV</option>
                        <option value="pickup">Pickup</option>
                    </select>
                </div>

                <div class="table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Registration</th>
                                <th>Make / Model</th>
                                <th>Type</th>
                                <th>Fuel</th>
                                <th>Status</th>
                                <th>Odometer</th>
                                <th>Year</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="vehicles-body">
                            <tr>
                                <td colspan="8">
                                    <div class="page-loader">
                                        <div class="spinner"></div> Loading...
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="pagination" id="pagination">
                        <span id="pagination-info"></span>
                        <div class="pagination-btns" id="pagination-btns"></div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Add/Edit Vehicle Modal -->
    <div class="modal-backdrop hidden" id="vehicle-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-title">Add Vehicle</h2>
                <button class="modal-close" onclick="closeModal()">‚úï</button>
            </div>
            <div id="modal-alert" class="alert"></div>
            <form id="vehicle-form">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Registration Number *</label>
                        <input type="text" class="form-input" id="f-reg" placeholder="MH-12-AB-1234" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Type *</label>
                        <select class="form-select" id="f-type" required>
                            <option value="">Select...</option>
                            <option value="truck">Truck</option>
                            <option value="van">Van</option>
                            <option value="car">Car</option>
                            <option value="bus">Bus</option>
                            <option value="motorcycle">Motorcycle</option>
                            <option value="suv">SUV</option>
                            <option value="pickup">Pickup</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Make *</label>
                        <input type="text" class="form-input" id="f-make" placeholder="Toyota" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Model *</label>
                        <input type="text" class="form-input" id="f-model" placeholder="Hilux" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Year *</label>
                        <input type="number" class="form-input" id="f-year" placeholder="2022" required min="1990"
                            max="2027">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Fuel Type</label>
                        <select class="form-select" id="f-fuel">
                            <option value="diesel">Diesel</option>
                            <option value="petrol">Petrol</option>
                            <option value="electric">Electric</option>
                            <option value="hybrid">Hybrid</option>
                            <option value="cng">CNG</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Color</label>
                        <input type="text" class="form-input" id="f-color" placeholder="White">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Odometer (km)</label>
                        <input type="number" class="form-input" id="f-odometer" placeholder="0" min="0">
                    </div>
                </div>
                <div class="form-group" id="f-status-wrap" style="display:none;">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="f-status">
                        <option value="idle">Idle</option>
                        <option value="active">Active</option>
                        <option value="maintenance">Maintenance</option>
                        <option value="retired">Retired</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <input type="text" class="form-input" id="f-notes" placeholder="Optional notes...">
                </div>
                <div style="display:flex;gap:12px;margin-top:4px;">
                    <button type="button" class="btn btn-secondary w-full" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary w-full" id="modal-save-btn">Save Vehicle</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/js/api.js"></script>
    <script>
        requireAuth();

        const statusBadge = { active: 'badge-green', idle: 'badge-amber', maintenance: 'badge-red', retired: 'badge-gray' };
        let editId = null;
        let currentPage = 1;
        let searchTimeout;

        function debounceSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(loadVehicles, 400);
        }

        async function loadVehicles(page = 1) {
            currentPage = page;
            const search = document.getElementById('search-input').value;
            const status = document.getElementById('status-filter').value;
            const type = document.getElementById('type-filter').value;

            const params = { page, limit: 15 };
            if (search) params.search = search;
            if (status) params.status = status;
            if (type) params.type = type;

            const res = await api.get('/vehicles', params);
            const tbody = document.getElementById('vehicles-body');

            if (!res?.ok) { toast.error('Failed to load vehicles.'); return; }
            const { vehicles, total, pages } = res.data;

            if (!vehicles.length) {
                tbody.innerHTML = `<tr><td colspan="8"><div class="empty-state"><div class="empty-icon">üöó</div><h3>No vehicles found</h3><p>Add your first vehicle to get started.</p></div></td></tr>`;
                document.getElementById('pagination-info').textContent = '';
                document.getElementById('pagination-btns').innerHTML = '';
                return;
            }

            tbody.innerHTML = vehicles.map(v => `
    <tr>
      <td><span class="fw-600 text-accent">${v.registrationNumber}</span></td>
      <td>${v.make} ${v.model}</td>
      <td><span class="badge badge-blue" style="text-transform:capitalize;">${v.type}</span></td>
      <td>${v.fuelType}</td>
      <td><span class="badge ${statusBadge[v.status] || 'badge-gray'}">${v.status}</span></td>
      <td>${v.odometer?.toLocaleString() || 0} km</td>
      <td>${v.year}</td>
      <td>
        <div style="display:flex;gap:6px;">
          <button class="btn btn-secondary btn-sm btn-icon" onclick="openModal('${v._id}')" title="Edit">‚úèÔ∏è</button>
          <button class="btn btn-danger btn-sm btn-icon" onclick="deleteVehicle('${v._id}')" title="Delete">üóëÔ∏è</button>
        </div>
      </td>
    </tr>
  `).join('');

            document.getElementById('pagination-info').textContent = `${total} vehicle${total === 1 ? '' : 's'}`;
            const btns = document.getElementById('pagination-btns');
            btns.innerHTML = '';
            const prevBtn = document.createElement('button');
            prevBtn.className = 'page-btn'; prevBtn.textContent = '‚Üê'; prevBtn.disabled = page === 1;
            prevBtn.onclick = () => loadVehicles(page - 1);
            btns.appendChild(prevBtn);
            for (let i = 1; i <= pages; i++) {
                const b = document.createElement('button');
                b.className = `page-btn ${i === page ? 'active' : ''}`;
                b.textContent = i; b.onclick = () => loadVehicles(i);
                btns.appendChild(b);
            }
            const nextBtn = document.createElement('button');
            nextBtn.className = 'page-btn'; nextBtn.textContent = '‚Üí'; nextBtn.disabled = page === pages;
            nextBtn.onclick = () => loadVehicles(page + 1);
            btns.appendChild(nextBtn);
        }

        async function openModal(id = null) {
            editId = id;
            document.getElementById('modal-title').textContent = id ? 'Edit Vehicle' : 'Add Vehicle';
            document.getElementById('vehicle-form').reset();
            document.getElementById('f-status-wrap').style.display = id ? 'block' : 'none';
            hideAlert('modal-alert');

            if (id) {
                const res = await api.get(`/vehicles/${id}`);
                if (!res?.ok) { toast.error('Failed to load vehicle.'); return; }
                const v = res.data.vehicle;
                document.getElementById('f-reg').value = v.registrationNumber;
                document.getElementById('f-type').value = v.type;
                document.getElementById('f-make').value = v.make;
                document.getElementById('f-model').value = v.model;
                document.getElementById('f-year').value = v.year;
                document.getElementById('f-fuel').value = v.fuelType;
                document.getElementById('f-color').value = v.color || '';
                document.getElementById('f-odometer').value = v.odometer || 0;
                document.getElementById('f-status').value = v.status;
                document.getElementById('f-notes').value = v.notes || '';
            }
            document.getElementById('vehicle-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('vehicle-modal').classList.add('hidden');
            editId = null;
        }

        document.getElementById('vehicle-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('modal-save-btn');
            setLoading(btn, true, 'Saving...');
            hideAlert('modal-alert');

            const data = {
                registrationNumber: document.getElementById('f-reg').value,
                type: document.getElementById('f-type').value,
                make: document.getElementById('f-make').value,
                model: document.getElementById('f-model').value,
                year: parseInt(document.getElementById('f-year').value),
                fuelType: document.getElementById('f-fuel').value,
                color: document.getElementById('f-color').value,
                odometer: parseInt(document.getElementById('f-odometer').value) || 0,
                notes: document.getElementById('f-notes').value,
            };
            if (editId) data.status = document.getElementById('f-status').value;

            const res = editId ? await api.put(`/vehicles/${editId}`, data) : await api.post('/vehicles', data);
            setLoading(btn, false);

            if (res?.ok) {
                toast.success(editId ? 'Vehicle updated!' : 'Vehicle added!');
                closeModal();
                loadVehicles(currentPage);
            } else {
                showAlert('modal-alert', res?.data?.message || 'Failed to save vehicle.');
            }
        });

        async function deleteVehicle(id) {
            if (!confirm('Delete this vehicle?')) return;
            const res = await api.delete(`/vehicles/${id}`);
            if (res?.ok) { toast.success('Vehicle deleted.'); loadVehicles(currentPage); }
            else toast.error(res?.data?.message || 'Delete failed.');
        }

        loadVehicles();
    </script>
</body>

</html>